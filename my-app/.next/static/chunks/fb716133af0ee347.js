(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,73886,e=>{"use strict";e.s(["normalizeNumber",0,e=>{let t=Math.floor(e).toString(),s=[],a=t.split("").reverse(),l=0;return a.forEach(e=>{0!==l&&l%3==0&&s.push(","),s.push(e),l++}),s.toReversed().join("")}])},15843,e=>{"use strict";var t=e.i(43476);e.s(["DeleteIcon",0,e=>(0,t.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",fill:"currentColor",className:"bi bi-trash",viewBox:"0 0 16 16",...e,children:[(0,t.jsx)("path",{d:"M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"}),(0,t.jsx)("path",{d:"M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"})]})])},94271,e=>{"use strict";var t=e.i(43476);e.s(["Loading",0,e=>(0,t.jsxs)("svg",{className:"-ml-1 mr-3 h-5 w-5 animate-spin text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",...e,children:[(0,t.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,t.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]})])},55613,e=>{"use strict";var t=e.i(43476);let s=e=>(0,t.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",fill:"currentColor",className:"bi bi-x-lg",viewBox:"0 0 16 16",...e,children:(0,t.jsx)("path",{d:"M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"})});var a=e.i(47573),l=e.i(71645);let r=(0,l.forwardRef)((e,r)=>{let[n,d]=(0,l.useState)(e.defaultOpen??!1),i=(0,a.default)(()=>{e.onClose?.(),d(!1)});return((0,l.useImperativeHandle)(r,()=>({open:()=>{d(!0)},close:()=>{d(!1)}})),(0,l.useEffect)(()=>(n&&(document.body.style.position="fixed"),()=>{document.body.style.position="unset"}),[n]),n)?(0,t.jsx)("div",{className:"fixed top-0 right-0 bottom-0 left-0 z-50 flex justify-center bg-black/60 backdrop-blur-sm",children:(0,t.jsxs)("div",{ref:i,className:`bg-background animate-modal relative rounded-xl ${e.className}`,children:[(0,t.jsx)("button",{type:"button",onClick:()=>{e.onClose?.(),d(!1)},className:"bg-background absolute top-4 right-6 size-6 rounded-full p-1.5 text-gray-500 transition-colors hover:text-gray-700",children:(0,t.jsx)(s,{className:"size-full"})}),(0,t.jsx)("h1",{className:"from-primary-500 to-primary-600 rounded-t-xl bg-gradient-to-r px-6 py-4 text-lg font-semibold text-white sm:text-xl",children:e.title}),(0,t.jsx)("div",{className:"p-6",children:e.children})]})}):null});r.displayName="Modal",e.s(["Modal",0,r],55613)},1550,e=>{"use strict";let t="/api/aurora/budgets",s=async e=>{try{if(!e)return{status:!1,data:null,message:"缺少帳本 ID"};let s=await fetch(`${t}?account_id=${e}`).then(e=>e.json());return{status:!0,data:s,message:"success"}}catch(e){return console.error(e),{status:!1,data:null,message:"發生不預期的錯誤"}}},a=async e=>{try{let s=await fetch(t,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}).then(e=>e.json());return{status:!0,data:s,message:"success"}}catch(e){return console.error(e),{status:!1,message:"發生不預期的錯誤"}}},l=async e=>{try{return await fetch(`${t}?account_id=${e}`,{method:"DELETE"}),{status:!0,message:"success"}}catch(e){return console.error(e),{status:!1,message:"發生不預期的錯誤"}}};e.s(["deleteBudget",0,l,"getBudget",0,s,"putBudget",0,a])},44970,e=>{"use strict";var t=e.i(6705);e.s(["getExpenseFromData",0,e=>{let s=0,a=0;return e.forEach(e=>{e.type===t.SpendingType.Income?s+=Number(e.amount):a+=Number(e.amount)}),{totalIncome:s,totalOutcome:a}}])},30210,e=>{"use strict";var t=e.i(43476);let s=e=>{let{children:s,className:a="",...l}=e;return(0,t.jsx)("h1",{className:`clipped-text gradient-r-from-purple-to-blue w-fit self-center p-6 text-xl font-bold sm:text-2xl ${a}`,...l,children:s})};var a=e.i(1550),l=e.i(10969),r=e.i(71645);let n=({children:e})=>{let[s,n]=(0,r.useState)(!0),[i,o]=(0,r.useState)(null),{db:c,getBudgetData:u,setBudgetData:m}=(0,l.useIDB)(),g=(0,r.useCallback)(e=>{o(e),n(!1)},[]),x=(0,r.useCallback)(async e=>{if(!c){n(!0),(0,a.getBudget)(e).then(e=>{e.status?g(e.data):g(null)}).catch(e=>{console.error(e),g(null)});return}try{let t=await u(c,e);t?(console.log("[BudgetProvider] Using cached budget data"),(0,r.startTransition)(()=>{o(t),n(!1)})):n(!0)}catch(e){console.error("[BudgetProvider] Error reading cache:",e),n(!0)}(0,a.getBudget)(e).then(t=>{t.status?((0,r.startTransition)(()=>{g(t.data)}),t.data&&m(c,e,t.data).catch(console.error)):g(null)}).catch(e=>{console.error(e),g(null)})},[c,u,m,g]),h=(0,r.useCallback)(async e=>{n(!0);let t=await (0,a.putBudget)(e);if(t.status&&t.data)g(t.data),c&&m(c,e.account_id,t.data).catch(console.error);else throw n(!1),Error(t.message)},[c,m,g]),b=(0,r.useCallback)(async e=>{n(!0);let t=await (0,a.deleteBudget)(e);if(t.status)g(null);else throw n(!1),Error(t.message)},[g]),f=(0,r.useMemo)(()=>({loading:s,budget:i,syncBudget:x,updateBudget:h,removeBudget:b}),[s,i,x,h,b]);return(0,t.jsx)(d.Provider,{value:f,children:e})},d=(0,r.createContext)({loading:!0,budget:null,syncBudget:()=>{},updateBudget:async()=>{},removeBudget:async()=>{}}),i=()=>(0,r.useContext)(d);var o=e.i(73886),c=e.i(44970);let u=({yearlySpending:e})=>{let{budget:s}=i(),a=(0,r.useMemo)(()=>{if(!s?.monthly_items||0===s.monthly_items.length)return 0;let e=0;return s.monthly_items.forEach(t=>{Object.values(t.months||{}).forEach(t=>{e+=t})}),e},[s?.monthly_items]),l=(0,r.useMemo)(()=>{let{totalOutcome:t}=(0,c.getExpenseFromData)(e);return t},[e]),n=a?l/a*100:0;return(0,t.jsxs)("div",{className:"bg-background w-full rounded-xl p-6 shadow",children:[(0,t.jsx)("div",{className:"flex items-center justify-between",children:(0,t.jsx)("h2",{className:"text-xl font-bold",children:"年度預算"})}),(0,t.jsxs)("div",{className:"mt-4",children:[(0,t.jsxs)("p",{className:"text-3xl font-bold",children:[(0,o.normalizeNumber)(a)," 元"]}),(0,t.jsx)("p",{className:"text-sm text-gray-500",children:"(自動計算)"}),(0,t.jsx)("div",{className:"mt-2 h-2 w-full rounded-full bg-gray-200",children:(0,t.jsx)("div",{className:"h-full rounded-full bg-gradient-to-r from-purple-500 to-blue-500",style:{width:`${Math.min(n,100)}%`}})}),(0,t.jsxs)("p",{className:"mt-2 text-sm text-gray-600",children:["已使用 ",(0,o.normalizeNumber)(l)," 元 (",n.toFixed(1),"%)"]})]})]})},m=({yearlySpending:e})=>{let{budget:s}=i(),{monthlyBudget:a,spent:l}=(0,r.useMemo)(()=>{let t=new Date().getMonth()+1,a=0;s?.monthly_items&&s.monthly_items.forEach(e=>{let s=e.months?.[t.toString()];s&&(a+=s)});let l=e.filter(e=>new Date(e.date).getMonth()+1===t),{totalOutcome:r}=(0,c.getExpenseFromData)(l);return{monthlyBudget:a,spent:r}},[s?.monthly_items,e]),n=a?l/a*100:0;return(0,t.jsxs)("div",{className:"bg-background w-full rounded-xl p-6 shadow",children:[(0,t.jsx)("h2",{className:"text-xl font-bold",children:"本月預算"}),(0,t.jsxs)("div",{className:"mt-4",children:[(0,t.jsxs)("p",{className:"text-3xl font-bold",children:[(0,o.normalizeNumber)(a)," 元"]}),(0,t.jsx)("p",{className:"text-sm text-gray-500",children:"(由月度項目自動計算)"}),(0,t.jsx)("div",{className:"mt-2 h-2 w-full rounded-full bg-gray-200",children:(0,t.jsx)("div",{className:`h-full rounded-full ${n>100?"bg-red-500":"bg-gradient-to-r from-purple-500 to-blue-500"}`,style:{width:`${Math.min(n,100)}%`}})}),(0,t.jsxs)("p",{className:"mt-2 text-sm text-gray-600",children:["已使用 ",(0,o.normalizeNumber)(l)," 元 (",n.toFixed(1),"%)"]})]})]})};var g=e.i(55613),x=e.i(94271),h=e.i(15843),b=e.i(76877),f=e.i(6705);let p=[{value:1,label:"一月"},{value:2,label:"二月"},{value:3,label:"三月"},{value:4,label:"四月"},{value:5,label:"五月"},{value:6,label:"六月"},{value:7,label:"七月"},{value:8,label:"八月"},{value:9,label:"九月"},{value:10,label:"十月"},{value:11,label:"十一月"},{value:12,label:"十二月"}],y=({yearlySpending:e})=>{let{budget:s,updateBudget:a}=i(),{currentGroup:l}=(0,b.useGroupCtx)(),[n,d]=(0,r.useState)(!1),[c,u]=(0,r.useState)(null),[m,y]=(0,r.useState)(""),[v,j]=(0,r.useState)(0),[N,w]=(0,r.useState)(!1),_=(0,r.useMemo)(()=>{let e={};return p.forEach(t=>{e[t.value]=0}),s?.monthly_items&&s.monthly_items.forEach(t=>{Object.entries(t.months||{}).forEach(([t,s])=>{let a=parseInt(t);e[a]=(e[a]||0)+s})}),e},[s?.monthly_items]),C=(0,r.useMemo)(()=>{let t={};return p.forEach(e=>{t[e.value]=0}),e.forEach(e=>{if(e.type===f.SpendingType.Outcome){let s=new Date(e.date).getMonth()+1,a=Number(e.amount);t[s]=(t[s]||0)+a}}),t},[e]),S=(0,r.useCallback)(e=>s?.monthly_items?s.monthly_items.map((t,s)=>({index:s,name:t.name,amount:t.months?.[e.toString()]||0})).filter(e=>e.amount>0):[],[s?.monthly_items]),k=(0,r.useCallback)(async()=>{if(!l?.account_id||!m.trim()||null===c)return void alert("請填寫項目名稱與金額");w(!0);try{let e,t=s?.monthly_items?.findIndex(e=>e.name===m);if(void 0!==t&&t>=0)(e=[...s?.monthly_items||[]])[t]={...e[t],months:{...e[t].months,[c.toString()]:v}};else{let t={name:m,months:{[c.toString()]:v}};e=[...s?.monthly_items||[],t]}await a({budget_id:s?.budget_id,account_id:l.account_id,annual_budget:s?.annual_budget||0,monthly_items:e}),d(!1)}catch(e){console.error(e),alert("儲存失敗，請稍後再試")}finally{w(!1)}},[l,s,m,v,c,a]),M=(0,r.useCallback)(async(e,t)=>{if(l?.account_id&&window.confirm("確定要刪除此項目嗎？"))try{let r=[...s?.monthly_items||[]],n=r[t],d={...n.months};delete d[e.toString()],0===Object.keys(d).length?r.splice(t,1):r[t]={...n,months:d},await a({budget_id:s?.budget_id,account_id:l.account_id,annual_budget:s?.annual_budget||0,monthly_items:r})}catch(e){console.error(e),alert("刪除失敗，請稍後再試")}},[l,s,a]),E=new Date().getMonth()+1;return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:"grid w-full grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3 md:max-w-250",children:p.map(e=>{let s=S(e.value),a=_[e.value],l=C[e.value],r=a>0?l/a*100:0,n=e.value===E,i=l>a;return(0,t.jsxs)("div",{className:`bg-background rounded-xl p-4 shadow ${n?"ring-2 ring-primary-500":""}`,children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("h3",{className:"text-lg font-bold",children:[e.label,n&&(0,t.jsx)("span",{className:"text-primary-500 ml-2 text-xs",children:"(本月)"})]}),(0,t.jsx)("button",{type:"button",onClick:()=>{u(e.value),y(""),j(0),d(!0)},className:"text-primary-500 hover:text-primary-600 text-sm font-medium",children:"+ 新增"})]}),(0,t.jsxs)("div",{className:"mt-2",children:[(0,t.jsxs)("p",{className:"text-2xl font-bold",children:[(0,o.normalizeNumber)(a)," 元"]}),(0,t.jsxs)("p",{className:"text-sm text-gray-500",children:["已使用 ",(0,o.normalizeNumber)(l)," 元",a>0&&(0,t.jsxs)("span",{className:`ml-1 font-medium ${i?"text-red-600":"text-green-600"}`,children:["(",r.toFixed(1),"%)"]})]})]}),a>0&&(0,t.jsx)("div",{className:"mt-2",children:(0,t.jsx)("div",{className:"h-2 w-full overflow-hidden rounded-full bg-gray-200",children:(0,t.jsx)("div",{className:`h-full transition-all ${i?"bg-red-500":"bg-green-500"}`,style:{width:`${Math.min(r,100)}%`}})})}),(0,t.jsx)("div",{className:"mt-3 space-y-2",children:s.length>0?s.map(s=>(0,t.jsxs)("div",{className:"flex items-center justify-between rounded-lg bg-gray-50 p-2",children:[(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsx)("p",{className:"text-sm font-medium",children:s.name}),(0,t.jsxs)("p",{className:"text-xs text-gray-500",children:[(0,o.normalizeNumber)(s.amount)," 元"]})]}),(0,t.jsx)("button",{type:"button",onClick:()=>M(e.value,s.index),className:"rounded p-1 text-red-500 transition-colors hover:bg-red-50 active:bg-red-50",children:(0,t.jsx)(h.DeleteIcon,{className:"size-4"})})]},`${e.value}-${s.index}`)):(0,t.jsx)("p",{className:"py-4 text-center text-xs text-gray-400",children:"尚未新增項目"})})]},e.value)})}),n&&null!==c&&(0,t.jsx)(g.Modal,{defaultOpen:!0,onClose:()=>d(!1),className:"flex w-full flex-col self-end sm:max-w-96 sm:self-center sm:rounded-xl",title:`新增 ${p[c-1].label} 預算項目`,children:(0,t.jsxs)("div",{className:"flex w-full flex-col gap-4",children:[(0,t.jsxs)("fieldset",{children:[(0,t.jsx)("legend",{className:"mb-2",children:"項目名稱"}),(0,t.jsx)("input",{type:"text",className:"h-10 w-full rounded-md border border-solid border-gray-300 px-3 py-1",value:m,onChange:e=>y(e.target.value),placeholder:"例如：房租、水電費"})]}),(0,t.jsxs)("fieldset",{children:[(0,t.jsx)("legend",{className:"mb-2",children:"預算金額"}),(0,t.jsx)("input",{type:"number",className:"h-10 w-full rounded-md border border-solid border-gray-300 px-3 py-1",value:v||"",onChange:e=>j(Number(e.target.value)),placeholder:"5000"})]}),(0,t.jsxs)("div",{className:"flex w-full justify-end gap-2 pt-4",children:[(0,t.jsx)("button",{type:"button",onClick:()=>d(!1),disabled:N,className:"rounded-lg border border-solid border-gray-300 px-4 py-2 text-gray-500",children:"取消"}),(0,t.jsx)("button",{type:"button",onClick:k,disabled:N,className:"bg-text text-background flex items-center justify-center rounded-lg px-6 py-2 font-bold transition-colors hover:bg-gray-800 active:bg-gray-800 disabled:cursor-not-allowed disabled:bg-gray-400",children:N?(0,t.jsx)(x.Loading,{className:"size-5 animate-spin"}):"新增"})]})]})})]})},v=()=>(0,t.jsxs)("div",{className:"content-wrapper animate-pulse",children:[(0,t.jsx)("div",{className:"h-8 w-48 bg-gray-200 rounded mb-2"}),(0,t.jsxs)("div",{className:"flex w-full flex-col gap-5",children:[(0,t.jsxs)("div",{className:"bg-background flex w-full flex-col gap-4 rounded-2xl border border-solid border-gray-200 p-6 shadow-sm",children:[(0,t.jsx)("div",{className:"h-6 w-32 bg-gray-200 rounded"}),(0,t.jsx)("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-3",children:[1,2,3].map(e=>(0,t.jsxs)("div",{className:"flex flex-col gap-2 rounded-lg bg-gray-50 p-4",children:[(0,t.jsx)("div",{className:"h-4 w-24 bg-gray-200 rounded"}),(0,t.jsx)("div",{className:"h-8 w-32 bg-gray-200 rounded"})]},e))})]}),(0,t.jsxs)("div",{className:"bg-background flex w-full flex-col gap-4 rounded-2xl border border-solid border-gray-200 p-6 shadow-sm",children:[(0,t.jsx)("div",{className:"h-6 w-32 bg-gray-200 rounded"}),(0,t.jsx)("div",{className:"grid grid-cols-2 gap-3 md:grid-cols-4 lg:grid-cols-6",children:[1,2,3,4,5,6,7,8,9,10,11,12].map(e=>(0,t.jsxs)("div",{className:"flex flex-col gap-2 rounded-lg border border-gray-200 bg-gray-50 p-3",children:[(0,t.jsx)("div",{className:"h-4 w-16 bg-gray-200 rounded"}),(0,t.jsx)("div",{className:"h-6 w-20 bg-gray-200 rounded"}),(0,t.jsx)("div",{className:"h-3 w-full bg-gray-100 rounded-full mt-1",children:(0,t.jsx)("div",{className:"h-3 bg-gray-200 rounded-full",style:{width:"60%"}})})]},e))}),(0,t.jsx)("div",{className:"mt-4 flex flex-col gap-2",children:[1,2,3,4,5].map(e=>(0,t.jsxs)("div",{className:"flex items-center gap-3 rounded-lg border border-gray-200 bg-gray-50 p-3",children:[(0,t.jsx)("div",{className:"size-6 bg-gray-200 rounded"}),(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsx)("div",{className:"h-4 w-32 bg-gray-200 rounded mb-1"}),(0,t.jsx)("div",{className:"h-3 w-24 bg-gray-200 rounded"})]}),(0,t.jsx)("div",{className:"h-5 w-20 bg-gray-200 rounded"})]},e))})]})]})]});var j=e.i(39287);function N(){let{currentGroup:e}=(0,b.useGroupCtx)(),{syncBudget:s,budget:a,loading:l}=i(),[n,d]=(0,r.useState)([]),[o,c]=(0,r.useState)(!0);return((0,r.useEffect)(()=>{if(!e?.account_id)return;let t=e.account_id;Promise.all([s(t),(async()=>{let e=new Date,s=new Date(e.getFullYear(),0,1),a=new Date(e.getFullYear(),11,31,23,59,59),l=await (0,j.getItems)(String(t),void 0,s.toISOString(),a.toISOString());l.status&&l.data&&(0,r.startTransition)(()=>{d(l.data),o&&c(!1)})})()]).catch(e=>{console.error("[BudgetPage] Error fetching data:",e)})},[e?.account_id,s,o]),e)?o&&(l||0===n.length)?(0,t.jsx)(v,{}):(0,t.jsxs)("div",{className:"content-wrapper space-y-3 md:space-y-5",children:[(0,t.jsxs)("div",{className:"grid w-full grid-cols-1 gap-3 md:max-w-250 md:grid-cols-2 md:gap-5",children:[(0,t.jsx)(u,{yearlySpending:n}),(0,t.jsx)(m,{yearlySpending:n})]}),(0,t.jsx)(y,{yearlySpending:n})]}):(0,t.jsx)("div",{className:"flex w-full flex-1 items-center justify-center",children:(0,t.jsx)("p",{className:"text-gray-400",children:"請先選擇一個帳本"})})}function w(){return(0,t.jsxs)("div",{className:"bg-soft relative flex w-full flex-1 flex-col",children:[(0,t.jsx)(s,{children:"預算管理"}),(0,t.jsx)(n,{children:(0,t.jsx)(N,{})})]})}e.s(["default",()=>w],30210)}]);