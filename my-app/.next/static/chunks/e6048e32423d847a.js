(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,73886,e=>{"use strict";e.s(["normalizeNumber",0,e=>{let t=Math.floor(e).toString(),l=[],a=t.split("").reverse(),s=0;return a.forEach(e=>{0!==s&&s%3==0&&l.push(","),l.push(e),s++}),l.toReversed().join("")}])},15843,e=>{"use strict";var t=e.i(43476);e.s(["DeleteIcon",0,e=>(0,t.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",fill:"currentColor",className:"bi bi-trash",viewBox:"0 0 16 16",...e,children:[(0,t.jsx)("path",{d:"M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"}),(0,t.jsx)("path",{d:"M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"})]})])},94271,e=>{"use strict";var t=e.i(43476);e.s(["Loading",0,e=>(0,t.jsxs)("svg",{className:"-ml-1 mr-3 h-5 w-5 animate-spin text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",...e,children:[(0,t.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,t.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]})])},55613,e=>{"use strict";var t=e.i(43476);let l=e=>(0,t.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",fill:"currentColor",className:"bi bi-x-lg",viewBox:"0 0 16 16",...e,children:(0,t.jsx)("path",{d:"M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"})});var a=e.i(47573),s=e.i(71645);let r=(0,s.forwardRef)((e,r)=>{let[n,o]=(0,s.useState)(e.defaultOpen??!1),i=(0,a.default)(()=>{e.onClose?.(),o(!1)});return((0,s.useImperativeHandle)(r,()=>({open:()=>{o(!0)},close:()=>{o(!1)}})),(0,s.useEffect)(()=>(n&&(document.body.style.position="fixed"),()=>{document.body.style.position="unset"}),[n]),n)?(0,t.jsx)("div",{className:"fixed top-0 right-0 bottom-0 left-0 z-50 flex justify-center bg-black/60 backdrop-blur-sm",children:(0,t.jsxs)("div",{ref:i,className:`bg-background animate-modal relative rounded-xl ${e.className}`,children:[(0,t.jsx)("button",{type:"button",onClick:()=>{e.onClose?.(),o(!1)},className:"bg-background absolute top-4 right-6 size-6 rounded-full p-1.5 text-gray-500 transition-colors hover:text-gray-700",children:(0,t.jsx)(l,{className:"size-full"})}),(0,t.jsx)("h1",{className:"from-primary-500 to-primary-600 rounded-t-xl bg-gradient-to-r px-6 py-4 text-lg font-semibold text-white sm:text-xl",children:e.title}),(0,t.jsx)("div",{className:"p-6",children:e.children})]})}):null});r.displayName="Modal",e.s(["Modal",0,r],55613)},1550,e=>{"use strict";let t="/api/aurora/budgets",l=async e=>{try{if(!e)return{status:!1,data:null,message:"缺少帳本 ID"};let l=await fetch(`${t}?account_id=${e}`).then(e=>e.json());return{status:!0,data:l,message:"success"}}catch(e){return console.error(e),{status:!1,data:null,message:"發生不預期的錯誤"}}},a=async e=>{try{let l=await fetch(t,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}).then(e=>e.json());return{status:!0,data:l,message:"success"}}catch(e){return console.error(e),{status:!1,message:"發生不預期的錯誤"}}},s=async e=>{try{return await fetch(`${t}?account_id=${e}`,{method:"DELETE"}),{status:!0,message:"success"}}catch(e){return console.error(e),{status:!1,message:"發生不預期的錯誤"}}};e.s(["deleteBudget",0,s,"getBudget",0,l,"putBudget",0,a])},44970,e=>{"use strict";var t=e.i(6705);e.s(["getExpenseFromData",0,e=>{let l=0,a=0;return e.forEach(e=>{e.type===t.SpendingType.Income?l+=Number(e.amount):a+=Number(e.amount)}),{totalIncome:l,totalOutcome:a}}])},30210,e=>{"use strict";var t=e.i(43476);let l=e=>{let{children:l,className:a="",...s}=e;return(0,t.jsx)("h1",{className:`clipped-text gradient-r-from-purple-to-blue w-fit self-center p-6 text-xl font-bold sm:text-2xl ${a}`,...s,children:l})};var a=e.i(1550),s=e.i(10969),r=e.i(71645);let n=({children:e})=>{let[l,n]=(0,r.useState)(!0),[i,d]=(0,r.useState)(null),{db:c,getBudgetData:u,setBudgetData:m}=(0,s.useIDB)(),h=(0,r.useCallback)(e=>{d(e),n(!1)},[]),x=(0,r.useCallback)(async e=>{if(!c){n(!0),(0,a.getBudget)(e).then(e=>{e.status?h(e.data):h(null)}).catch(e=>{console.error(e),h(null)});return}try{let t=await u(c,e);t?(console.log("[BudgetProvider] Using cached budget data"),(0,r.startTransition)(()=>{d(t),n(!1)})):n(!0)}catch(e){console.error("[BudgetProvider] Error reading cache:",e),n(!0)}(0,a.getBudget)(e).then(t=>{t.status?((0,r.startTransition)(()=>{h(t.data)}),t.data&&m(c,e,t.data).catch(console.error)):h(null)}).catch(e=>{console.error(e),h(null)})},[c,u,m,h]),g=(0,r.useCallback)(async e=>{n(!0);let t=await (0,a.putBudget)(e);if(t.status&&t.data)h(t.data),c&&m(c,e.account_id,t.data).catch(console.error);else throw n(!1),Error(t.message)},[c,m,h]),b=(0,r.useCallback)(async e=>{n(!0);let t=await (0,a.deleteBudget)(e);if(t.status)h(null);else throw n(!1),Error(t.message)},[h]),f=(0,r.useMemo)(()=>({loading:l,budget:i,syncBudget:x,updateBudget:g,removeBudget:b}),[l,i,x,g,b]);return(0,t.jsx)(o.Provider,{value:f,children:e})},o=(0,r.createContext)({loading:!0,budget:null,syncBudget:()=>{},updateBudget:async()=>{},removeBudget:async()=>{}}),i=()=>(0,r.useContext)(o);var d=e.i(73886),c=e.i(44970);let u=({yearlySpending:e})=>{let{budget:l}=i(),a=(0,r.useMemo)(()=>{if(!l?.monthly_items||0===l.monthly_items.length)return 0;let e=0;return l.monthly_items.forEach(t=>{Object.values(t.months||{}).forEach(t=>{e+=t})}),e},[l?.monthly_items]),s=(0,r.useMemo)(()=>{let{totalOutcome:t}=(0,c.getExpenseFromData)(e);return t},[e]),n=a?s/a*100:0;return(0,t.jsxs)("div",{className:"bg-background w-full rounded-xl p-6 shadow",children:[(0,t.jsx)("div",{className:"flex items-center justify-between",children:(0,t.jsx)("h2",{className:"text-xl font-bold",children:"年度預算"})}),(0,t.jsxs)("div",{className:"mt-4",children:[(0,t.jsxs)("p",{className:"text-3xl font-bold",children:[(0,d.normalizeNumber)(a)," 元"]}),(0,t.jsx)("p",{className:"text-sm text-gray-500",children:"(自動計算)"}),(0,t.jsx)("div",{className:"mt-2 h-2 w-full rounded-full bg-gray-200",children:(0,t.jsx)("div",{className:"h-full rounded-full bg-gradient-to-r from-purple-500 to-blue-500",style:{width:`${Math.min(n,100)}%`}})}),(0,t.jsxs)("p",{className:"mt-2 text-sm text-gray-600",children:["已使用 ",(0,d.normalizeNumber)(s)," 元 (",n.toFixed(1),"%)"]})]})]})},m=({yearlySpending:e})=>{let{budget:l}=i(),{monthlyBudget:a,spent:s}=(0,r.useMemo)(()=>{let t=new Date().getMonth()+1,a=0;l?.monthly_items&&l.monthly_items.forEach(e=>{let l=e.months?.[t.toString()];l&&(a+=l)});let s=e.filter(e=>new Date(e.date).getMonth()+1===t),{totalOutcome:r}=(0,c.getExpenseFromData)(s);return{monthlyBudget:a,spent:r}},[l?.monthly_items,e]),n=a?s/a*100:0;return(0,t.jsxs)("div",{className:"bg-background w-full rounded-xl p-6 shadow",children:[(0,t.jsx)("h2",{className:"text-xl font-bold",children:"本月預算"}),(0,t.jsxs)("div",{className:"mt-4",children:[(0,t.jsxs)("p",{className:"text-3xl font-bold",children:[(0,d.normalizeNumber)(a)," 元"]}),(0,t.jsx)("p",{className:"text-sm text-gray-500",children:"(由月度項目自動計算)"}),(0,t.jsx)("div",{className:"mt-2 h-2 w-full rounded-full bg-gray-200",children:(0,t.jsx)("div",{className:`h-full rounded-full ${n>100?"bg-red-500":"bg-gradient-to-r from-purple-500 to-blue-500"}`,style:{width:`${Math.min(n,100)}%`}})}),(0,t.jsxs)("p",{className:"mt-2 text-sm text-gray-600",children:["已使用 ",(0,d.normalizeNumber)(s)," 元 (",n.toFixed(1),"%)"]})]})]})};var h=e.i(55613),x=e.i(94271),g=e.i(15843),b=e.i(76877),f=e.i(6705);let p=[{value:1,label:"一月"},{value:2,label:"二月"},{value:3,label:"三月"},{value:4,label:"四月"},{value:5,label:"五月"},{value:6,label:"六月"},{value:7,label:"七月"},{value:8,label:"八月"},{value:9,label:"九月"},{value:10,label:"十月"},{value:11,label:"十一月"},{value:12,label:"十二月"}],y=({yearlySpending:e})=>{let{budget:l,updateBudget:a}=i(),{currentGroup:s}=(0,b.useGroupCtx)(),[n,o]=(0,r.useState)(!1),[c,u]=(0,r.useState)(null),[m,y]=(0,r.useState)(""),[v,j]=(0,r.useState)(0),[N,w]=(0,r.useState)(!1),_=(0,r.useMemo)(()=>{let e={};return p.forEach(t=>{e[t.value]=0}),l?.monthly_items&&l.monthly_items.forEach(t=>{Object.entries(t.months||{}).forEach(([t,l])=>{let a=parseInt(t);e[a]=(e[a]||0)+l})}),e},[l?.monthly_items]),C=(0,r.useMemo)(()=>{let t={};return p.forEach(e=>{t[e.value]=0}),e.forEach(e=>{if(e.type===f.SpendingType.Outcome){let l=new Date(e.date).getMonth()+1,a=Number(e.amount);t[l]=(t[l]||0)+a}}),t},[e]),S=(0,r.useCallback)(e=>l?.monthly_items?l.monthly_items.map((t,l)=>({index:l,name:t.name,amount:t.months?.[e.toString()]||0})).filter(e=>e.amount>0):[],[l?.monthly_items]),k=(0,r.useCallback)(async()=>{if(!s?.account_id||!m.trim()||null===c)return void alert("請填寫項目名稱與金額");w(!0);try{let e,t=l?.monthly_items?.findIndex(e=>e.name===m);if(void 0!==t&&t>=0)(e=[...l?.monthly_items||[]])[t]={...e[t],months:{...e[t].months,[c.toString()]:v}};else{let t={name:m,months:{[c.toString()]:v}};e=[...l?.monthly_items||[],t]}await a({budget_id:l?.budget_id,account_id:s.account_id,annual_budget:l?.annual_budget||0,monthly_items:e}),o(!1)}catch(e){console.error(e),alert("儲存失敗，請稍後再試")}finally{w(!1)}},[s,l,m,v,c,a]),M=(0,r.useCallback)(async(e,t)=>{if(s?.account_id&&window.confirm("確定要刪除此項目嗎？"))try{let r=[...l?.monthly_items||[]],n=r[t],o={...n.months};delete o[e.toString()],0===Object.keys(o).length?r.splice(t,1):r[t]={...n,months:o},await a({budget_id:l?.budget_id,account_id:s.account_id,annual_budget:l?.annual_budget||0,monthly_items:r})}catch(e){console.error(e),alert("刪除失敗，請稍後再試")}},[s,l,a]),E=new Date().getMonth()+1;return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:"grid w-full grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3 md:max-w-250",children:p.map(e=>{let l=S(e.value),a=_[e.value],s=C[e.value],r=a>0?s/a*100:0,n=e.value===E,i=s>a;return(0,t.jsxs)("div",{className:`bg-background rounded-xl p-4 shadow ${n?"ring-2 ring-primary-500":""}`,children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("h3",{className:"text-lg font-bold",children:[e.label,n&&(0,t.jsx)("span",{className:"text-primary-500 ml-2 text-xs",children:"(本月)"})]}),(0,t.jsx)("button",{type:"button",onClick:()=>{u(e.value),y(""),j(0),o(!0)},className:"text-primary-500 hover:text-primary-600 text-sm font-medium",children:"+ 新增"})]}),(0,t.jsxs)("div",{className:"mt-2",children:[(0,t.jsxs)("p",{className:"text-2xl font-bold",children:[(0,d.normalizeNumber)(a)," 元"]}),(0,t.jsxs)("p",{className:"text-sm text-gray-500",children:["已使用 ",(0,d.normalizeNumber)(s)," 元",a>0&&(0,t.jsxs)("span",{className:`ml-1 font-medium ${i?"text-red-600":"text-green-600"}`,children:["(",r.toFixed(1),"%)"]})]})]}),a>0&&(0,t.jsx)("div",{className:"mt-2",children:(0,t.jsx)("div",{className:"h-2 w-full overflow-hidden rounded-full bg-gray-200",children:(0,t.jsx)("div",{className:`h-full transition-all ${i?"bg-red-500":"bg-green-500"}`,style:{width:`${Math.min(r,100)}%`}})})}),(0,t.jsx)("div",{className:"mt-3 space-y-2",children:l.length>0?l.map(l=>(0,t.jsxs)("div",{className:"flex items-center justify-between rounded-lg bg-gray-50 p-2",children:[(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsx)("p",{className:"text-sm font-medium",children:l.name}),(0,t.jsxs)("p",{className:"text-xs text-gray-500",children:[(0,d.normalizeNumber)(l.amount)," 元"]})]}),(0,t.jsx)("button",{type:"button",onClick:()=>M(e.value,l.index),className:"rounded p-1 text-red-500 transition-colors hover:bg-red-50 active:bg-red-50",children:(0,t.jsx)(g.DeleteIcon,{className:"size-4"})})]},`${e.value}-${l.index}`)):(0,t.jsx)("p",{className:"py-4 text-center text-xs text-gray-400",children:"尚未新增項目"})})]},e.value)})}),n&&null!==c&&(0,t.jsx)(h.Modal,{defaultOpen:!0,onClose:()=>o(!1),className:"flex w-full flex-col self-end sm:max-w-96 sm:self-center sm:rounded-xl",title:`新增 ${p[c-1].label} 預算項目`,children:(0,t.jsxs)("div",{className:"flex w-full flex-col gap-4",children:[(0,t.jsxs)("fieldset",{children:[(0,t.jsx)("legend",{className:"mb-2",children:"項目名稱"}),(0,t.jsx)("input",{type:"text",className:"h-10 w-full rounded-md border border-solid border-gray-300 px-3 py-1",value:m,onChange:e=>y(e.target.value),placeholder:"例如：房租、水電費"})]}),(0,t.jsxs)("fieldset",{children:[(0,t.jsx)("legend",{className:"mb-2",children:"預算金額"}),(0,t.jsx)("input",{type:"number",className:"h-10 w-full rounded-md border border-solid border-gray-300 px-3 py-1",value:v||"",onChange:e=>j(Number(e.target.value)),placeholder:"5000"})]}),(0,t.jsxs)("div",{className:"flex w-full justify-end gap-2 pt-4",children:[(0,t.jsx)("button",{type:"button",onClick:()=>o(!1),disabled:N,className:"rounded-lg border border-solid border-gray-300 px-4 py-2 text-gray-500",children:"取消"}),(0,t.jsx)("button",{type:"button",onClick:k,disabled:N,className:"bg-text text-background flex items-center justify-center rounded-lg px-6 py-2 font-bold transition-colors hover:bg-gray-800 active:bg-gray-800 disabled:cursor-not-allowed disabled:bg-gray-400",children:N?(0,t.jsx)(x.Loading,{className:"size-5 animate-spin"}):"新增"})]})]})})]})};var v=e.i(39287);function j(){let{currentGroup:e}=(0,b.useGroupCtx)(),{syncBudget:l}=i(),[a,s]=(0,r.useState)([]);return((0,r.useEffect)(()=>{if(!e?.account_id)return;let t=e.account_id;Promise.all([l(t),(async()=>{let e=new Date,l=new Date(e.getFullYear(),0,1),a=new Date(e.getFullYear(),11,31,23,59,59),n=await (0,v.getItems)(String(t),void 0,l.toISOString(),a.toISOString());n.status&&n.data&&(0,r.startTransition)(()=>{s(n.data)})})()]).catch(e=>{console.error("[BudgetPage] Error fetching data:",e)})},[e?.account_id,l]),e)?(0,t.jsxs)("div",{className:"content-wrapper space-y-3 md:space-y-5",children:[(0,t.jsxs)("div",{className:"grid w-full grid-cols-1 gap-3 md:max-w-250 md:grid-cols-2 md:gap-5",children:[(0,t.jsx)(u,{yearlySpending:a}),(0,t.jsx)(m,{yearlySpending:a})]}),(0,t.jsx)(y,{yearlySpending:a})]}):(0,t.jsx)("div",{className:"flex w-full flex-1 items-center justify-center",children:(0,t.jsx)("p",{className:"text-gray-400",children:"請先選擇一個帳本"})})}function N(){return(0,t.jsxs)("div",{className:"bg-soft relative flex w-full flex-1 flex-col",children:[(0,t.jsx)(l,{children:"預算管理"}),(0,t.jsx)(n,{children:(0,t.jsx)(j,{})})]})}e.s(["default",()=>N],30210)}]);