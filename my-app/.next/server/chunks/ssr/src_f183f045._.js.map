{"version":3,"sources":["../../../../src/components/icons/Loading.tsx","../../../../src/app/group/invite/%5Bid%5D/InviteConfirm.tsx"],"sourcesContent":["import { HTMLAttributes } from 'react';\n\nexport const Loading = (props: HTMLAttributes<HTMLOrSVGElement>) => {\n  return (\n    <svg\n      className=\"-ml-1 mr-3 h-5 w-5 animate-spin text-white\"\n      xmlns=\"http://www.w3.org/2000/svg\"\n      fill=\"none\"\n      viewBox=\"0 0 24 24\"\n      {...props}\n    >\n      <circle\n        className=\"opacity-25\"\n        cx=\"12\"\n        cy=\"12\"\n        r=\"10\"\n        stroke=\"currentColor\"\n        strokeWidth=\"4\"\n      ></circle>\n      <path\n        className=\"opacity-75\"\n        fill=\"currentColor\"\n        d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"\n      ></path>\n    </svg>\n  );\n};\n","'use client';\n\nimport { Loading } from '@/components/icons/Loading';\nimport { useGroupCtx } from '@/context/GroupProvider';\nimport { useUserConfigCtx } from '@/context/UserConfigProvider';\nimport { signIn } from 'next-auth/react';\nimport { useParams, useRouter } from 'next/navigation';\nimport { useCallback, useEffect, useState } from 'react';\n\nexport const InviteConfirm = () => {\n  const { id } = useParams();\n  const router = useRouter();\n  const { config, loading: loadingUserData } = useUserConfigCtx();\n  const { syncGroup, groups } = useGroupCtx();\n  const [invitedGroup, setInvitedGroup] = useState<Group | null>(null);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n\n  // 獲取被邀請的群組資訊\n  useEffect(() => {\n    if (!id) {\n      setError('無效的邀請連結');\n      setLoading(false);\n      return;\n    }\n\n    // 透過 account_id 查詢單個群組資訊\n    fetch(`/api/aurora/groups?id=${id}&type=single`)\n      .then((res) => res.json())\n      .then((data) => {\n        if (data && data.length > 0) {\n          setInvitedGroup(data[0]);\n        } else {\n          setError('找不到該群組');\n        }\n      })\n      .catch((err) => {\n        console.error('查詢群組失敗:', err);\n        setError('查詢群組失敗，請稍後再試');\n      })\n      .finally(() => {\n        setLoading(false);\n      });\n  }, [id]);\n\n  // 處理未登入用戶的登入流程\n  const handleLogin = useCallback(() => {\n    const currentPath = window.location.pathname;\n    signIn(undefined, { callbackUrl: currentPath });\n  }, []);\n\n  const handleJoinGroup = useCallback(async () => {\n    if (!config?.user_id || !invitedGroup?.account_id) {\n      alert('無法加入群組，缺少必要資訊');\n      return;\n    }\n\n    // 檢查是否已是成員\n    const isAlreadyMember = groups.some(\n      (group) => group.account_id === invitedGroup.account_id\n    );\n\n    if (isAlreadyMember) {\n      alert('您已經是該群組的成員了');\n      router.push('/group');\n      return;\n    }\n\n    setLoading(true);\n    try {\n      // 添加成員到 account_members 表\n      const response = await fetch('/api/aurora/group/member', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          account_id: invitedGroup.account_id,\n          user_id: config.user_id,\n          role: 'Viewer',\n        }),\n      });\n\n      if (!response.ok) {\n        throw new Error('Failed to add group member');\n      }\n\n      // 刷新群組列表\n      await syncGroup(config.user_id);\n\n      alert('成功加入群組！');\n      router.push('/group');\n    } catch (error) {\n      console.error('加入群組失敗:', error);\n      alert('加入群組失敗，請稍後再試');\n    } finally {\n      setLoading(false);\n    }\n  }, [config, invitedGroup, groups, syncGroup, router]);\n\n  // 顯示載入中\n  if (loading || loadingUserData) {\n    return (\n      <div className=\"m-auto\">\n        <Loading className=\"text-text size-10 animate-spin\" />\n      </div>\n    );\n  }\n\n  // 顯示錯誤\n  if (error || !invitedGroup) {\n    return (\n      <div className=\"bg-background flex w-80 flex-col rounded-2xl border border-solid border-red-300 p-6 text-center shadow\">\n        <p className=\"text-red-500\">{error || '無法載入群組資訊'}</p>\n        <button\n          type=\"button\"\n          onClick={() => router.push('/group')}\n          className=\"mt-4 rounded bg-gray-500 px-4 py-2 text-white hover:bg-gray-600\"\n        >\n          返回群組頁面\n        </button>\n      </div>\n    );\n  }\n\n  // 用戶未登入，顯示登入提示\n  if (!config?.user_id) {\n    return (\n      <div className=\"bg-background flex w-80 flex-col rounded-2xl border border-solid border-blue-300 p-6 text-center shadow\">\n        <h2 className=\"mb-4 text-lg font-bold\">需要登入</h2>\n        <p className=\"mb-2 text-gray-600\">\n          您收到了加入帳本\n          <strong className=\"mx-1 text-blue-600\">{invitedGroup.name}</strong>\n          的邀請\n        </p>\n        <p className=\"mb-6 text-sm text-gray-500\">請先登入以繼續加入帳本</p>\n        <div className=\"flex flex-col gap-3\">\n          <button\n            type=\"button\"\n            onClick={handleLogin}\n            className=\"rounded bg-blue-500 px-4 py-2 text-white transition-colors hover:bg-blue-600\"\n          >\n            前往登入\n          </button>\n          <button\n            type=\"button\"\n            onClick={() => router.push('/')}\n            className=\"text-sm text-gray-500 hover:text-gray-700\"\n          >\n            返回首頁\n          </button>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"bg-background flex w-80 flex-col rounded-2xl border border-solid border-gray-300 pt-5 pb-4 shadow\">\n      <h1 className=\"mb-6 w-full px-5 text-start text-lg sm:text-xl\">\n        是否加入\n        <strong className=\"ml-2 font-bold\">{invitedGroup.name}</strong>\n        帳本？\n      </h1>\n      <div className=\"px-5 pb-4\">\n        <p className=\"mb-2 text-sm text-gray-600\">帳本資訊：</p>\n        <div className=\"rounded-lg bg-gray-50 p-3 text-sm\">\n          <p>\n            <span className=\"font-medium\">擁有者：</span>\n            {invitedGroup.owner_name || invitedGroup.owner_email || '未知'}\n          </p>\n          <p className=\"mt-1\">\n            <span className=\"font-medium\">成員數量：</span>\n            {invitedGroup.member_count || 0} 人\n          </p>\n        </div>\n        <p className=\"mt-3 text-xs text-gray-500\">\n          加入後您將成為 <strong>Viewer</strong>（檢視者）角色\n        </p>\n      </div>\n      <div className=\"flex items-center justify-between gap-4 border-t border-solid border-gray-300 px-4 pt-4\">\n        <button\n          type=\"button\"\n          onClick={() => router.push('/group')}\n          className=\"active:text-background hover:text-background rounded border border-solid border-red-500 px-6 py-1 text-red-500 transition-colors hover:bg-red-500 active:bg-red-500\"\n        >\n          取消\n        </button>\n        <button\n          type=\"button\"\n          onClick={handleJoinGroup}\n          disabled={loading}\n          className=\"text-background rounded border border-solid border-green-500 bg-green-500 px-6 py-1 transition-colors hover:border-green-400 hover:bg-green-400 active:border-green-400 active:bg-green-400 disabled:cursor-not-allowed disabled:bg-gray-400 disabled:border-gray-400\"\n        >\n          {loading ? '加入中...' : '加入'}\n        </button>\n      </div>\n    </div>\n  );\n};\n"],"names":[],"mappings":"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"}