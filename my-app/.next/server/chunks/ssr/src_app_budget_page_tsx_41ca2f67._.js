module.exports=[28716,a=>{"use strict";var b=a.i(87924);let c=a=>{let{children:c,className:d="",...e}=a;return(0,b.jsx)("h1",{className:`clipped-text gradient-r-from-purple-to-blue w-fit self-center p-6 text-xl font-bold sm:text-2xl ${d}`,...e,children:c})};var d=a.i(61417),e=a.i(89829),f=a.i(72131);let g=({children:a})=>{let[c,g]=(0,f.useState)(!0),[i,j]=(0,f.useState)(null),{db:k,getBudgetData:l,setBudgetData:m}=(0,e.useIDB)(),n=(0,f.useCallback)(a=>{j(a),g(!1)},[]),o=(0,f.useCallback)(async a=>{if(!k){g(!0),(0,d.getBudget)(a).then(a=>{a.status?n(a.data):n(null)}).catch(a=>{console.error(a),n(null)});return}try{let b=await l(k,a);b?(console.log("[BudgetProvider] Using cached budget data"),(0,f.startTransition)(()=>{j(b),g(!1)})):g(!0)}catch(a){console.error("[BudgetProvider] Error reading cache:",a),g(!0)}(0,d.getBudget)(a).then(b=>{b.status?((0,f.startTransition)(()=>{n(b.data)}),b.data&&m(k,a,b.data).catch(console.error)):n(null)}).catch(a=>{console.error(a),n(null)})},[k,l,m,n]),p=(0,f.useCallback)(async a=>{g(!0);let b=await (0,d.putBudget)(a);if(b.status&&b.data)n(b.data),k&&m(k,a.account_id,b.data).catch(console.error);else throw g(!1),Error(b.message)},[k,m,n]),q=(0,f.useCallback)(async a=>{g(!0);let b=await (0,d.deleteBudget)(a);if(b.status)n(null);else throw g(!1),Error(b.message)},[n]),r=(0,f.useMemo)(()=>({loading:c,budget:i,syncBudget:o,updateBudget:p,removeBudget:q}),[c,i,o,p,q]);return(0,b.jsx)(h.Provider,{value:r,children:a})},h=(0,f.createContext)({loading:!0,budget:null,syncBudget:()=>{},updateBudget:async()=>{},removeBudget:async()=>{}}),i=()=>(0,f.useContext)(h);var j=a.i(90768),k=a.i(58769);let l=({yearlySpending:a})=>{let{budget:c}=i(),d=(0,f.useMemo)(()=>{if(!c?.monthly_items||0===c.monthly_items.length)return 0;let a=0;return c.monthly_items.forEach(b=>{Object.values(b.months||{}).forEach(b=>{a+=b})}),a},[c?.monthly_items]),e=(0,f.useMemo)(()=>{let{totalOutcome:b}=(0,k.getExpenseFromData)(a);return b},[a]),g=d?e/d*100:0;return(0,b.jsxs)("div",{className:"bg-background w-full rounded-xl p-6 shadow",children:[(0,b.jsx)("div",{className:"flex items-center justify-between",children:(0,b.jsx)("h2",{className:"text-xl font-bold",children:"年度預算"})}),(0,b.jsxs)("div",{className:"mt-4",children:[(0,b.jsxs)("p",{className:"text-3xl font-bold",children:[(0,j.normalizeNumber)(d)," 元"]}),(0,b.jsx)("p",{className:"text-sm text-gray-500",children:"(自動計算)"}),(0,b.jsx)("div",{className:"mt-2 h-2 w-full rounded-full bg-gray-200",children:(0,b.jsx)("div",{className:"h-full rounded-full bg-gradient-to-r from-purple-500 to-blue-500",style:{width:`${Math.min(g,100)}%`}})}),(0,b.jsxs)("p",{className:"mt-2 text-sm text-gray-600",children:["已使用 ",(0,j.normalizeNumber)(e)," 元 (",g.toFixed(1),"%)"]})]})]})},m=({yearlySpending:a})=>{let{budget:c}=i(),{monthlyBudget:d,spent:e}=(0,f.useMemo)(()=>{let b=new Date().getMonth()+1,d=0;c?.monthly_items&&c.monthly_items.forEach(a=>{let c=a.months?.[b.toString()];c&&(d+=c)});let e=a.filter(a=>new Date(a.date).getMonth()+1===b),{totalOutcome:f}=(0,k.getExpenseFromData)(e);return{monthlyBudget:d,spent:f}},[c?.monthly_items,a]),g=d?e/d*100:0;return(0,b.jsxs)("div",{className:"bg-background w-full rounded-xl p-6 shadow",children:[(0,b.jsx)("h2",{className:"text-xl font-bold",children:"本月預算"}),(0,b.jsxs)("div",{className:"mt-4",children:[(0,b.jsxs)("p",{className:"text-3xl font-bold",children:[(0,j.normalizeNumber)(d)," 元"]}),(0,b.jsx)("p",{className:"text-sm text-gray-500",children:"(由月度項目自動計算)"}),(0,b.jsx)("div",{className:"mt-2 h-2 w-full rounded-full bg-gray-200",children:(0,b.jsx)("div",{className:`h-full rounded-full ${g>100?"bg-red-500":"bg-gradient-to-r from-purple-500 to-blue-500"}`,style:{width:`${Math.min(g,100)}%`}})}),(0,b.jsxs)("p",{className:"mt-2 text-sm text-gray-600",children:["已使用 ",(0,j.normalizeNumber)(e)," 元 (",g.toFixed(1),"%)"]})]})]})};var n=a.i(28268),o=a.i(1270),p=a.i(67551),q=a.i(10584),r=a.i(71336);let s=[{value:1,label:"一月"},{value:2,label:"二月"},{value:3,label:"三月"},{value:4,label:"四月"},{value:5,label:"五月"},{value:6,label:"六月"},{value:7,label:"七月"},{value:8,label:"八月"},{value:9,label:"九月"},{value:10,label:"十月"},{value:11,label:"十一月"},{value:12,label:"十二月"}],t=({yearlySpending:a})=>{let{budget:c,updateBudget:d}=i(),{currentGroup:e}=(0,q.useGroupCtx)(),[g,h]=(0,f.useState)(!1),[k,l]=(0,f.useState)(null),[m,t]=(0,f.useState)(""),[u,v]=(0,f.useState)(0),[w,x]=(0,f.useState)(!1),y=(0,f.useMemo)(()=>{let a={};return s.forEach(b=>{a[b.value]=0}),c?.monthly_items&&c.monthly_items.forEach(b=>{Object.entries(b.months||{}).forEach(([b,c])=>{let d=parseInt(b);a[d]=(a[d]||0)+c})}),a},[c?.monthly_items]),z=(0,f.useMemo)(()=>{let b={};return s.forEach(a=>{b[a.value]=0}),a.forEach(a=>{if(a.type===r.SpendingType.Outcome){let c=new Date(a.date).getMonth()+1,d=Number(a.amount);b[c]=(b[c]||0)+d}}),b},[a]),A=(0,f.useCallback)(a=>c?.monthly_items?c.monthly_items.map((b,c)=>({index:c,name:b.name,amount:b.months?.[a.toString()]||0})).filter(a=>a.amount>0):[],[c?.monthly_items]),B=(0,f.useCallback)(async()=>{if(!e?.account_id||!m.trim()||null===k)return void alert("請填寫項目名稱與金額");x(!0);try{let a,b=c?.monthly_items?.findIndex(a=>a.name===m);if(void 0!==b&&b>=0)(a=[...c?.monthly_items||[]])[b]={...a[b],months:{...a[b].months,[k.toString()]:u}};else{let b={name:m,months:{[k.toString()]:u}};a=[...c?.monthly_items||[],b]}await d({budget_id:c?.budget_id,account_id:e.account_id,annual_budget:c?.annual_budget||0,monthly_items:a}),h(!1)}catch(a){console.error(a),alert("儲存失敗，請稍後再試")}finally{x(!1)}},[e,c,m,u,k,d]),C=(0,f.useCallback)(async(a,b)=>{if(e?.account_id&&window.confirm("確定要刪除此項目嗎？"))try{let f=[...c?.monthly_items||[]],g=f[b],h={...g.months};delete h[a.toString()],0===Object.keys(h).length?f.splice(b,1):f[b]={...g,months:h},await d({budget_id:c?.budget_id,account_id:e.account_id,annual_budget:c?.annual_budget||0,monthly_items:f})}catch(a){console.error(a),alert("刪除失敗，請稍後再試")}},[e,c,d]),D=new Date().getMonth()+1;return(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)("div",{className:"grid w-full grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3 md:max-w-250",children:s.map(a=>{let c=A(a.value),d=y[a.value],e=z[a.value],f=d>0?e/d*100:0,g=a.value===D,i=e>d;return(0,b.jsxs)("div",{className:`bg-background rounded-xl p-4 shadow ${g?"ring-2 ring-primary-500":""}`,children:[(0,b.jsxs)("div",{className:"flex items-center justify-between",children:[(0,b.jsxs)("h3",{className:"text-lg font-bold",children:[a.label,g&&(0,b.jsx)("span",{className:"text-primary-500 ml-2 text-xs",children:"(本月)"})]}),(0,b.jsx)("button",{type:"button",onClick:()=>{l(a.value),t(""),v(0),h(!0)},className:"text-primary-500 hover:text-primary-600 text-sm font-medium",children:"+ 新增"})]}),(0,b.jsxs)("div",{className:"mt-2",children:[(0,b.jsxs)("p",{className:"text-2xl font-bold",children:[(0,j.normalizeNumber)(d)," 元"]}),(0,b.jsxs)("p",{className:"text-sm text-gray-500",children:["已使用 ",(0,j.normalizeNumber)(e)," 元",d>0&&(0,b.jsxs)("span",{className:`ml-1 font-medium ${i?"text-red-600":"text-green-600"}`,children:["(",f.toFixed(1),"%)"]})]})]}),d>0&&(0,b.jsx)("div",{className:"mt-2",children:(0,b.jsx)("div",{className:"h-2 w-full overflow-hidden rounded-full bg-gray-200",children:(0,b.jsx)("div",{className:`h-full transition-all ${i?"bg-red-500":"bg-green-500"}`,style:{width:`${Math.min(f,100)}%`}})})}),(0,b.jsx)("div",{className:"mt-3 space-y-2",children:c.length>0?c.map(c=>(0,b.jsxs)("div",{className:"flex items-center justify-between rounded-lg bg-gray-50 p-2",children:[(0,b.jsxs)("div",{className:"flex-1",children:[(0,b.jsx)("p",{className:"text-sm font-medium",children:c.name}),(0,b.jsxs)("p",{className:"text-xs text-gray-500",children:[(0,j.normalizeNumber)(c.amount)," 元"]})]}),(0,b.jsx)("button",{type:"button",onClick:()=>C(a.value,c.index),className:"rounded p-1 text-red-500 transition-colors hover:bg-red-50 active:bg-red-50",children:(0,b.jsx)(p.DeleteIcon,{className:"size-4"})})]},`${a.value}-${c.index}`)):(0,b.jsx)("p",{className:"py-4 text-center text-xs text-gray-400",children:"尚未新增項目"})})]},a.value)})}),g&&null!==k&&(0,b.jsx)(n.Modal,{defaultOpen:!0,onClose:()=>h(!1),className:"flex w-full flex-col self-end sm:max-w-96 sm:self-center sm:rounded-xl",title:`新增 ${s[k-1].label} 預算項目`,children:(0,b.jsxs)("div",{className:"flex w-full flex-col gap-4",children:[(0,b.jsxs)("fieldset",{children:[(0,b.jsx)("legend",{className:"mb-2",children:"項目名稱"}),(0,b.jsx)("input",{type:"text",className:"h-10 w-full rounded-md border border-solid border-gray-300 px-3 py-1",value:m,onChange:a=>t(a.target.value),placeholder:"例如：房租、水電費"})]}),(0,b.jsxs)("fieldset",{children:[(0,b.jsx)("legend",{className:"mb-2",children:"預算金額"}),(0,b.jsx)("input",{type:"number",className:"h-10 w-full rounded-md border border-solid border-gray-300 px-3 py-1",value:u||"",onChange:a=>v(Number(a.target.value)),placeholder:"5000"})]}),(0,b.jsxs)("div",{className:"flex w-full justify-end gap-2 pt-4",children:[(0,b.jsx)("button",{type:"button",onClick:()=>h(!1),disabled:w,className:"rounded-lg border border-solid border-gray-300 px-4 py-2 text-gray-500",children:"取消"}),(0,b.jsx)("button",{type:"button",onClick:B,disabled:w,className:"bg-text text-background flex items-center justify-center rounded-lg px-6 py-2 font-bold transition-colors hover:bg-gray-800 active:bg-gray-800 disabled:cursor-not-allowed disabled:bg-gray-400",children:w?(0,b.jsx)(o.Loading,{className:"size-5 animate-spin"}):"新增"})]})]})})]})};var u=a.i(22283);function v(){let{currentGroup:a}=(0,q.useGroupCtx)(),{syncBudget:c}=i(),[d,e]=(0,f.useState)([]);return((0,f.useEffect)(()=>{if(!a?.account_id)return;let b=a.account_id;Promise.all([c(b),(async()=>{let a=new Date,c=new Date(a.getFullYear(),0,1),d=new Date(a.getFullYear(),11,31,23,59,59),g=await (0,u.getItems)(String(b),void 0,c.toISOString(),d.toISOString());g.status&&g.data&&(0,f.startTransition)(()=>{e(g.data)})})()]).catch(a=>{console.error("[BudgetPage] Error fetching data:",a)})},[a?.account_id,c]),a)?(0,b.jsxs)("div",{className:"content-wrapper space-y-3 md:space-y-5",children:[(0,b.jsxs)("div",{className:"grid w-full grid-cols-1 gap-3 md:max-w-250 md:grid-cols-2 md:gap-5",children:[(0,b.jsx)(l,{yearlySpending:d}),(0,b.jsx)(m,{yearlySpending:d})]}),(0,b.jsx)(t,{yearlySpending:d})]}):(0,b.jsx)("div",{className:"flex w-full flex-1 items-center justify-center",children:(0,b.jsx)("p",{className:"text-gray-400",children:"請先選擇一個帳本"})})}function w(){return(0,b.jsxs)("div",{className:"bg-soft relative flex w-full flex-1 flex-col",children:[(0,b.jsx)(c,{children:"預算管理"}),(0,b.jsx)(g,{children:(0,b.jsx)(v,{})})]})}a.s(["default",()=>w],28716)}];

//# sourceMappingURL=src_app_budget_page_tsx_41ca2f67._.js.map